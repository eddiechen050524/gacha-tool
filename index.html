<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HoYoverse è§’è‰²æŠ½é¸å·¥å…· v2.0</title>
    <style>
        /* --- æ ¸å¿ƒè®Šæ•¸èˆ‡é‡ç½® --- */
        :root {
            --primary: #3b82f6;
            --secondary: #60a5fa;
            --bg: #f0f2f5;
            --card-bg: white;
            --text: #333;
            --accent: #d4a329;
            --radius: 12px;
            --shadow: 0 4px 20px rgba(0,0,0,0.08);
            --font-main: "å¾®è»Ÿæ­£é»‘é«”", sans-serif;
        }

        /* --- [ä¸»é¡Œ 1] åŸç¥ --- */
        [data-theme="genshin"] {
            --primary: #4A90E2;
            --bg: linear-gradient(135deg, #e0f7fa 0%, #f0f4c3 100%);
            --card-bg: rgba(255, 255, 255, 0.95);
            --text: #4a5568;
            --radius: 20px;
        }

        /* --- [ä¸»é¡Œ 2] æ˜Ÿç©¹éµé“ --- */
        [data-theme="hsr"] {
            --primary: #A277FF;
            --bg: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            --card-bg: rgba(20, 20, 35, 0.9);
            --text: #E0E0E0;
            --accent: #E5C07B;
            --radius: 4px;
            --shadow: 0 0 20px rgba(162, 119, 255, 0.2);
        }

        /* --- [ä¸»é¡Œ 3] çµ•å€é›¶ --- */
        [data-theme="zzz"] {
            --primary: #D3FE34;
            --bg: #111 url('data:image/svg+xml;utf8,<svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg"><g fill="%23222" fill-rule="evenodd"><path d="M0 40L40 0H20L0 20M40 40V20L20 40"/></g></svg>');
            --card-bg: #000;
            --text: #FFF;
            --accent: #FF4D00;
            --radius: 0px;
            --shadow: 8px 8px 0px rgba(211, 254, 52, 0.3);
            --font-main: "Arial Black", "å¾®è»Ÿæ­£é»‘é«”", sans-serif;
        }

        body {
            font-family: var(--font-main);
            background: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.5s ease;
        }

        .main-container {
            background: var(--card-bg);
            width: 100%;
            max-width: 900px;
            padding: 40px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            position: relative;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* --- å‹•ç•«ç‰¹æ•ˆ --- */
        @keyframes popIn {
            0% { transform: scale(0.9); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* --- é¦–é é¸æ“‡å¡ç‰‡ --- */
        .game-grid { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; margin-top: 40px; }
        .game-card {
            width: 220px; height: 300px; border-radius: 15px; background: white; cursor: pointer;
            transition: 0.3s; display: flex; flex-direction: column; align-items: center;
            justify-content: center; box-shadow: 0 10px 20px rgba(0,0,0,0.1); border: 4px solid transparent;
        }
        .game-card:hover { transform: translateY(-10px); }
        .card-gs { background: linear-gradient(to bottom, #dbeafe, #fff); color: #4A90E2; }
        .card-gs:hover { border-color: #4A90E2; }
        .card-hsr { background: linear-gradient(to bottom, #2e2e4d, #1a1a2e); color: #A277FF; }
        .card-hsr:hover { border-color: #A277FF; }
        .card-zzz { background: #000; color: #D3FE34; border: 2px solid #333; }
        .card-zzz:hover { border-color: #D3FE34; box-shadow: 5px 5px 0 #D3FE34; transform: translate(-5px, -5px); }
        .game-icon { font-size: 4em; margin-bottom: 20px; }
        .game-title { font-size: 1.5em; font-weight: bold; }

        /* --- UI å…ƒä»¶ --- */
        h1 { text-align: center; margin: 0 0 20px 0; }
        .nav-bar { display: flex; justify-content: space-between; border-bottom: 2px solid rgba(0,0,0,0.05); padding-bottom: 15px; margin-bottom: 20px; }
        
        .btn-nav {
            background: transparent; border: none; font-size: 1.1em; color: var(--text); opacity: 0.6;
            cursor: pointer; padding: 10px 20px; transition: 0.3s; border-radius: var(--radius);
        }
        .btn-nav.active { opacity: 1; background: var(--primary); color: white; font-weight: bold; }
        
        /* é‡å°ç‰¹å®šä¸»é¡Œçš„æŒ‰éˆ•æ–‡å­—é¡è‰²èª¿æ•´ */
        [data-theme="zzz"] .btn-nav.active { color: black; }

        .btn-back { background: rgba(0,0,0,0.1); border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; color: var(--text); }

        /* --- ç¯©é¸æŒ‰éˆ• --- */
        .filter-group { margin-bottom: 15px; border-bottom: 1px dashed rgba(128,128,128,0.2); padding-bottom: 10px; }
        .filter-label { font-weight: bold; width: 80px; display: inline-block; opacity: 0.8; }
        .filter-btn {
            background: rgba(128,128,128,0.1); border: 1px solid transparent; color: var(--text);
            padding: 6px 14px; margin: 4px; border-radius: 20px; cursor: pointer; transition: 0.2s;
        }
        [data-theme="zzz"] .filter-btn { border-radius: 0px; border: 1px solid #333; }
        .filter-btn:hover { background: rgba(128,128,128,0.2); }
        .filter-btn.active { background: var(--primary); color: #000; font-weight: bold; box-shadow: 0 0 10px var(--primary); }
        [data-theme="hsr"] .filter-btn.active, [data-theme="genshin"] .filter-btn.active { color: white; }

        /* --- æŠ½é¸èˆ‡éšŠä¼ --- */
        .draw-area { text-align: center; margin-top: 40px; }
        
        .action-buttons {
            display: flex; gap: 15px; justify-content: center; margin-bottom: 20px;
        }

        .draw-btn {
            background: var(--primary); color: #000; border: none; padding: 15px 40px;
            font-size: 1.5em; border-radius: 50px; cursor: pointer; font-weight: bold;
            box-shadow: 0 10px 30px -10px var(--primary); transition: 0.2s; position: relative; overflow: hidden;
            min-width: 200px;
        }
        .draw-btn:active { transform: scale(0.95); }
        .draw-btn.secondary {
            background: transparent; border: 2px solid var(--primary); color: var(--text);
            box-shadow: none; font-size: 1.2em; padding: 15px 30px;
        }
        .draw-btn.secondary:hover {
            background: rgba(0,0,0,0.05);
        }

        [data-theme="hsr"] .draw-btn:not(.secondary) { color: white; }
        [data-theme="genshin"] .draw-btn:not(.secondary) { color: white; }
        [data-theme="zzz"] .draw-btn { border-radius: 0; border: 3px solid #000; box-shadow: 8px 8px 0 #000; }
        
        /* å–®æŠ½çµæœ */
        .result-box {
            margin-top: 30px; padding: 20px; min-height: 100px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border-radius: var(--radius); background: rgba(0,0,0,0.03); border: 2px solid rgba(0,0,0,0.05);
        }
        .result-name { font-size: 3em; font-weight: bold; transition: 0.1s; }
        .result-tags { margin-top: 10px; font-size: 1.1em; opacity: 0.7; }
        .is-5star { color: var(--accent); text-shadow: 0 0 20px var(--accent); animation: popIn 0.3s; }
        .rolling { filter: blur(2px); opacity: 0.7; scale: 0.95; }

        /* éšŠä¼çµæœ */
        .team-container {
            display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-top: 20px;
        }
        .team-card {
            background: var(--card-bg); border: 2px solid rgba(0,0,0,0.1); border-radius: var(--radius);
            padding: 15px; width: 140px; text-align: center; animation: popIn 0.5s ease;
        }
        [data-theme="zzz"] .team-card { border-radius: 0; border: 2px solid #333; }
        .team-role-name { font-size: 1.2em; font-weight: bold; margin-bottom: 5px; }
        .team-role-tag { font-size: 0.8em; opacity: 0.7; }

        /* --- è¨­å®šé é¢ --- */
        .char-grid { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
        .char-card {
            width: 100px; padding: 12px 5px; border: 2px solid rgba(0,0,0,0.1); border-radius: var(--radius);
            cursor: pointer; text-align: center; background: var(--card-bg); transition: 0.3s; position: relative;
        }
        [data-theme="zzz"] .char-card { border-radius: 0; border: 2px solid #333; }
        .char-card.owned { border-color: var(--primary); background: rgba(59, 130, 246, 0.1); order: 0; }
        .char-card.owned::after { content: "âœ”"; color: var(--primary); font-weight: bold; }
        .char-card.not-owned { opacity: 0.4; filter: grayscale(100%); order: 1; background: transparent; }

        .user-tab {
            padding: 5px 15px; border: 1px solid rgba(0,0,0,0.2); border-radius: 20px;
            cursor: pointer; margin-right: 5px; opacity: 0.6; display: inline-block;
        }
        .user-tab.active { background: var(--primary); color: #000; opacity: 1; border-color: transparent; font-weight: bold; }
        [data-theme="hsr"] .user-tab.active, [data-theme="genshin"] .user-tab.active { color: white; }

        /* åŒ¯å…¥åŒ¯å‡ºå€å¡Š */
        .io-section {
            margin-bottom: 20px; padding: 15px; background: rgba(0,0,0,0.03);
            border-radius: var(--radius); text-align: center;
        }
        .io-input {
            width: 70%; padding: 8px; border-radius: 4px; border: 1px solid #ccc; font-family: monospace;
        }
        .io-btn {
            padding: 8px 15px; background: var(--text); color: var(--bg); border: none;
            border-radius: 4px; cursor: pointer; font-weight: bold;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="start-screen">
        <h1 style="font-size: 2.5em; margin-bottom: 40px; color:#444;">HoYoverse Picker</h1>
        <div class="game-grid">
            <div class="game-card card-gs" onclick="selectGame('genshin')">
                <div class="game-icon">âœ¨</div>
                <div class="game-title">Genshin Impact</div>
            </div>
            <div class="game-card card-hsr" onclick="selectGame('hsr')">
                <div class="game-icon">ğŸš‚</div>
                <div class="game-title">Star Rail</div>
            </div>
            <div class="game-card card-zzz" onclick="selectGame('zzz')">
                <div class="game-icon">ğŸ“º</div>
                <div class="game-title">Zenless Zone Zero</div>
            </div>
        </div>
    </div>

    <div id="app-content" class="main-container hidden">
        <div class="nav-bar">
            <button class="btn-back" onclick="goBackHome()">â¬… æ›´æ›éŠæˆ²</button>
            <h2 id="game-title-display" style="margin:0; font-size:1.5em;"></h2>
            <div style="width: 80px;"></div>
        </div>

        <div style="display:flex; justify-content:center; gap:15px; margin-bottom:30px;">
            <button class="btn-nav active" onclick="switchPage('draw')">æŠ½å¡ & çµ„éšŠ</button>
            <button class="btn-nav" onclick="switchPage('settings')">ç®¡ç†</button>
        </div>

        <div id="draw-page" class="page-section">
            <div id="filter-container"></div>
            <div id="pool-info" style="margin-bottom: 10px; opacity: 0.6; text-align: center;">ç­‰å¾…å•Ÿå‹•...</div>

            <div class="draw-area">
                <div class="action-buttons">
                    <button class="draw-btn" id="btn-draw" onclick="startRolling()">ç¥ˆé¡˜å–®æŠ½</button>
                    <button class="draw-btn secondary" onclick="drawTeam()">ä¸€éµçµ„éšŠ</button>
                </div>

                <div id="single-result-box" class="result-box">
                    <div id="result-name" class="result-name">æº–å‚™ä¸­</div>
                    <div id="result-tags" class="result-tags">---</div>
                </div>

                <div id="team-result-box" class="hidden">
                    <h3 style="margin: 20px 0 10px 0;">çµ„éšŠå»ºè­°</h3>
                    <div class="team-container" id="team-display"></div>
                </div>
            </div>
        </div>

        <div id="settings-page" class="page-section hidden">
            
            <div class="settings-header" style="margin-bottom: 20px;">
                <div class="user-tabs" id="user-tabs-container" style="margin-bottom: 10px;"></div>
                <div style="display:flex; gap:5px; align-items: center;">
                    <input type="text" id="new-user-name" placeholder="æ–°æˆå“¡å" style="padding:5px; border-radius:4px; border:1px solid #ccc;">
                    <button onclick="addNewUser()" style="padding:5px 15px; background:#10b981; color:white; border:none; border-radius:4px; cursor:pointer;">æ–°å¢</button>
                </div>
            </div>

            <div class="io-section">
                <h4 style="margin-top:0;">ğŸ“¦ è§’è‰²æ¸…å–®å‚™ä»½ (é‡å°ç•¶å‰é¸æ“‡çš„æˆå“¡)</h4>
                <div style="margin-bottom: 10px;">
                    <button class="io-btn" onclick="exportUserCode()">ğŸ“¤ ç”¢ç”ŸåŒ¯å‡ºä»£ç¢¼</button>
                </div>
                <div style="display:flex; gap:5px; justify-content: center;">
                    <input type="text" id="import-input" class="io-input" placeholder="è²¼ä¸Šä»£ç¢¼ä»¥åŒ¯å…¥...">
                    <button class="io-btn" onclick="importUserCode()">ğŸ“¥ åŒ¯å…¥</button>
                </div>
                <p style="font-size:0.8em; opacity:0.6; margin-bottom:0;">æ³¨æ„ï¼šåŒ¯å…¥å°‡æœƒè¦†è“‹æ­¤æˆå“¡ç›®å‰çš„æ“æœ‰ç‹€æ…‹</p>
            </div>

            <hr style="border:0; border-top:1px dashed #ccc; margin: 20px 0;">

            <p style="opacity:0.6; font-size:0.9em; text-align:center;">( é»æ“Šå¡ç‰‡å¯åˆ‡æ› æ“æœ‰ / æœªæ“æœ‰ )</p>
            <div class="char-grid" id="char-settings-grid"></div>
            
            <div style="text-align:center; margin-top:30px;">
                <button onclick="resetAllData()" style="background:#ef4444; color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer;">é‡ç½®æœ¬éŠæˆ²å…¨éƒ¨è³‡æ–™</button>
            </div>
        </div>
    </div>

    <script>
        // --- Config ---
        // å®šç¾©å„éŠæˆ²çš„çµ„éšŠäººæ•¸
        const teamSizes = { genshin: 4, hsr: 4, zzz: 3 };

        const gameConfigs = {
            genshin: {
                title: "åŸç¥", file: "data_genshin.json", highRarity: "5æ˜Ÿ",
                categories: [
                    { name: "æ“æœ‰", options: [] }, // å‹•æ…‹å¡«å…¥ User
                    { name: "ç¨€æœ‰åº¦", options: ["5æ˜Ÿ", "4æ˜Ÿ"] },
                    { name: "å…ƒç´ ", options: ["ç«", "æ°´", "é¢¨", "é›·", "è‰", "å†°", "å²©"] },
                    { name: "æ­¦å™¨", options: ["å–®æ‰‹åŠ", "é›™æ‰‹åŠ", "é•·æŸ„æ­¦å™¨", "æ³•å™¨", "å¼“"] },
                    { name: "åœ°å€", options: ["è’™å¾·", "ç’ƒæœˆ", "ç¨»å¦»", "é ˆå½Œ", "æ¥“ä¸¹", "ç´å¡”", "è‡³å†¬","æŒªå¾·å¡èŠ"] }
                ]
            },
            hsr: {
                title: "æ˜Ÿç©¹éµé“", file: "data_hsr.json", highRarity: "5æ˜Ÿ",
                categories: [
                    { name: "æ“æœ‰", options: [] },
                    { name: "ç¨€æœ‰åº¦", options: ["5æ˜Ÿ", "4æ˜Ÿ"] },
                    { name: "å±¬æ€§", options: ["ç‰©ç†", "ç«", "å†°", "é›·", "é¢¨", "é‡å­", "è™›æ•¸"] },
                    { name: "å‘½é€”", options: ["æ¯€æ»…", "å·¡çµ", "æ™ºè­˜", "åŒè«§", "è™›ç„¡", "å­˜è­·", "è±é¥’"] }
                ]
            },
            zzz: {
                title: "çµ•å€é›¶", file: "data_zzz.json", highRarity: "Sç´š",
                categories: [
                    { name: "æ“æœ‰", options: [] },
                    { name: "ç¨€æœ‰åº¦", options: ["Sç´š", "Aç´š"] },
                    { name: "å±¬æ€§", options: ["ç‰©ç†", "ç«", "å†°", "é›»", "ä»¥å¤ª"] },
                    { name: "ç‰¹æ€§", options: ["å¼·æ”»", "æ“Šç ´", "ç•°å¸¸", "æ”¯æ´", "é˜²è­·"] }
                ]
            }
        };

        let currentGame = "";
        let users = ["Eddie", "å¤§ä¿", "DD"];
        let currentEditUser = users[0];
        let baseCharacters = [];
        let fullData = [];
        let activeFilters = new Set();

        let isRolling = false;
        let rollInterval;

        // --- 1. æ ¸å¿ƒæµç¨‹ ---
        async function selectGame(gameId) {
            currentGame = gameId;
            document.documentElement.setAttribute('data-theme', gameId);
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('app-content').classList.remove('hidden');
            document.getElementById('game-title-display').innerText = gameConfigs[gameId].title;
            await loadGameData(gameConfigs[gameId].file);
        }

        function goBackHome() {
            location.reload();
        }

        async function loadGameData(file) {
            try {
                const res = await fetch(file);
                if (!res.ok) throw new Error();
                baseCharacters = await res.json();

                const savedUsers = localStorage.getItem('gacha_global_users');
                if (savedUsers) users = JSON.parse(savedUsers);
                // ç¢ºä¿ç›®å‰ç·¨è¼¯çš„ä½¿ç”¨è€…åœ¨æ¸…å–®å…§ï¼Œå¦å‰‡é è¨­ç¬¬ä¸€å€‹
                if (!users.includes(currentEditUser)) currentEditUser = users[0];

                const savedOwned = localStorage.getItem('gacha_owned_' + currentGame);
                fullData = JSON.parse(JSON.stringify(baseCharacters));

                if (savedOwned) {
                    const map = JSON.parse(savedOwned);
                    fullData.forEach(c => { if (map[c.name]) c.tags.push(...map[c.name]); });
                } else {
                    fullData.forEach(c => c.tags.push(...users)); 
                }

                initDrawUI();
                initSettingsUI();

            } catch (e) {
                alert("è®€å–è³‡æ–™å¤±æ•—ï¼Œè«‹ç¢ºèª JSON æª”æ¡ˆå­˜åœ¨ã€‚");
            }
        }

        // --- 2. æŠ½å¡ & çµ„éšŠé‚è¼¯ ---
        function initDrawUI() {
            const container = document.getElementById('filter-container');
            container.innerHTML = "";
            const config = gameConfigs[currentGame];
            config.categories[0].options = [...users];

            config.categories.forEach(cat => {
                const div = document.createElement('div');
                div.className = 'filter-group';
                div.innerHTML = `<span class="filter-label">${cat.name}</span>`;
                const opts = document.createElement('div');
                opts.className = 'filter-options';

                cat.options.forEach(tag => {
                    const btn = document.createElement('button');
                    btn.className = 'filter-btn';
                    if (activeFilters.has(tag)) btn.classList.add('active');
                    btn.innerText = tag;
                    btn.onclick = () => {
                        activeFilters.has(tag) ? activeFilters.delete(tag) : activeFilters.add(tag);
                        initDrawUI();
                    };
                    opts.appendChild(btn);
                });
                div.appendChild(opts);
                container.appendChild(div);
            });
            updatePoolCount();
        }

        function getPool() {
            if (activeFilters.size === 0) return fullData;
            return fullData.filter(c => [...activeFilters].every(tag => c.tags.includes(tag)));
        }

        function updatePoolCount() {
            const count = getPool().length;
            document.getElementById('pool-info').innerText = `ç¬¦åˆæ¢ä»¶ï¼š${count} ä½è§’è‰²`;
        }

        // --- å–®æŠ½ ---
        function startRolling() {
            if (isRolling) return;
            const pool = getPool();
            
            // UI åˆ‡æ›
            document.getElementById('single-result-box').classList.remove('hidden');
            document.getElementById('team-result-box').classList.add('hidden');

            if (pool.length === 0) {
                document.getElementById('result-name').innerText = "ç„¡è§’è‰²";
                return;
            }

            isRolling = true;
            const nameDiv = document.getElementById('result-name');
            const tagsDiv = document.getElementById('result-tags');
            const btn = document.getElementById('btn-draw');

            nameDiv.classList.remove('is-5star');
            nameDiv.classList.add('rolling');
            tagsDiv.innerText = "ç¥ˆé¡˜ä¸­...";
            btn.disabled = true;
            btn.innerText = "...";

            let rollCount = 0;
            rollInterval = setInterval(() => {
                const randomChar = pool[Math.floor(Math.random() * pool.length)];
                nameDiv.innerText = randomChar.name;
                rollCount++;
            }, 50);

            setTimeout(() => {
                clearInterval(rollInterval);
                const winner = pool[Math.floor(Math.random() * pool.length)];
                nameDiv.innerText = winner.name;
                tagsDiv.innerText = winner.tags.filter(t => !users.includes(t)).join(" Â· ");
                nameDiv.classList.remove('rolling');
                
                if (winner.tags.includes(gameConfigs[currentGame].highRarity)) {
                    nameDiv.classList.add('is-5star');
                }

                isRolling = false;
                btn.disabled = false;
                btn.innerText = "å†æ¬¡ç¥ˆé¡˜";
            }, 1000);
        }

        // --- â˜… æ–°å¢ï¼šä¸€éµçµ„éšŠ ---
        function drawTeam() {
            const pool = getPool();
            const size = teamSizes[currentGame];
            
            // UI åˆ‡æ›
            document.getElementById('single-result-box').classList.add('hidden');
            const teamBox = document.getElementById('team-result-box');
            teamBox.classList.remove('hidden');
            const teamDisplay = document.getElementById('team-display');
            teamDisplay.innerHTML = "";

            if (pool.length < size) {
                teamDisplay.innerHTML = `<div style="color:red;">è§’è‰²ä¸è¶³ ${size} äººï¼Œç„¡æ³•çµ„éšŠï¼<br>è«‹æ”¾å¯¬ç¯©é¸æ¢ä»¶ã€‚</div>`;
                return;
            }

            // æ´—ç‰Œç®—æ³• (Fisher-Yates Shuffle)
            const shuffled = [...pool];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }

            // å–å‰ N ä½
            const team = shuffled.slice(0, size);

            // é¡¯ç¤ºçµæœ
            team.forEach(char => {
                const highTag = gameConfigs[currentGame].highRarity;
                const isHigh = char.tags.includes(highTag);
                const color = isHigh ? "var(--accent)" : "var(--text)";
                const mainTag = char.tags.find(t => 
                    ["ç«","æ°´","é¢¨","é›·","è‰","å†°","å²©","ç‰©ç†","è™›æ•¸","é‡å­","ä¹™å¤ª"].includes(t)
                ) || "ä¸€èˆ¬";

                const card = document.createElement('div');
                card.className = 'team-card';
                if(isHigh) card.style.borderColor = "var(--accent)";
                
                card.innerHTML = `
                    <div class="team-role-name" style="color:${color}">${char.name}</div>
                    <div class="team-role-tag">${mainTag}</div>
                `;
                teamDisplay.appendChild(card);
            });
        }

        // --- 3. è¨­å®šèˆ‡åŒ¯å…¥åŒ¯å‡º ---
        function initSettingsUI() {
            const container = document.getElementById('user-tabs-container');
            container.innerHTML = "";
            users.forEach(u => {
                const btn = document.createElement('div');
                btn.className = `user-tab ${u === currentEditUser ? 'active' : ''}`;
                btn.innerText = u;
                btn.onclick = () => { currentEditUser = u; initSettingsUI(); };
                container.appendChild(btn);
            });
            renderGrid();
        }

        function renderGrid() {
            const grid = document.getElementById('char-settings-grid');
            grid.innerHTML = "";
            const highTag = gameConfigs[currentGame].highRarity;

            fullData.forEach(c => {
                const el = document.createElement('div');
                const owned = c.tags.includes(currentEditUser);
                el.className = `char-card ${owned ? 'owned' : 'not-owned'}`;
                const color = c.tags.includes(highTag) ? "var(--accent)" : "var(--text)";
                el.innerHTML = `<div style="color:${color}; font-weight:bold;">${c.name}</div>`;
                el.onclick = () => {
                    if (owned) {
                        c.tags = c.tags.filter(t => t !== currentEditUser);
                    } else {
                        c.tags.push(currentEditUser);
                    }
                    saveData();
                    initSettingsUI();
                };
                grid.appendChild(el);
            });
        }

        // â˜… æ–°å¢ï¼šåŒ¯å‡ºä»£ç¢¼ (Base64 + JSON)
        function exportUserCode() {
            // 1. æ‰¾å‡ºç•¶å‰ä½¿ç”¨è€…æ“æœ‰çš„æ‰€æœ‰è§’è‰²åç¨±
            const ownedNames = fullData
                .filter(c => c.tags.includes(currentEditUser))
                .map(c => c.name);

            if (ownedNames.length === 0) {
                alert("ç›®å‰æ­¤æˆå“¡æ²’æœ‰ä»»ä½•è§’è‰²ï¼Œç„¡æ³•åŒ¯å‡ºã€‚");
                return;
            }

            // 2. è½‰ JSON -> Encode URI (è™•ç†ä¸­æ–‡) -> Base64
            const jsonString = JSON.stringify(ownedNames);
            const code = btoa(encodeURIComponent(jsonString));

            // 3. é¡¯ç¤ºçµ¦ä½¿ç”¨è€…
            prompt(`è«‹è¤‡è£½ ${currentEditUser} çš„å‚™ä»½ä»£ç¢¼ï¼š`, code);
        }

        // â˜… æ–°å¢ï¼šåŒ¯å…¥ä»£ç¢¼
        function importUserCode() {
            const input = document.getElementById('import-input');
            const code = input.value.trim();
            if (!code) return;

            try {
                // 1. Base64 -> Decode URI -> Parse JSON
                const jsonString = decodeURIComponent(atob(code));
                const importedNames = JSON.parse(jsonString);

                if (!Array.isArray(importedNames)) throw new Error("æ ¼å¼éŒ¯èª¤");

                if(!confirm(`å³å°‡å°‡ä»£ç¢¼ä¸­çš„è§’è‰²æ¸…å–®è¦†è“‹è‡³ "${currentEditUser}"ï¼Œç¢ºå®šå—ï¼Ÿ`)) return;

                // 2. æ›´æ–° fullData
                fullData.forEach(c => {
                    if (importedNames.includes(c.name)) {
                        // å¦‚æœä»£ç¢¼è£¡æœ‰é€™éš»è§’è‰² -> ç¢ºä¿ä½¿ç”¨è€…æ“æœ‰
                        if (!c.tags.includes(currentEditUser)) {
                            c.tags.push(currentEditUser);
                        }
                    } else {
                        // å¦‚æœä»£ç¢¼è£¡æ²’æœ‰é€™éš»è§’è‰² -> ç¢ºä¿ä½¿ç”¨è€…æœªæ“æœ‰ (è¦†è“‹é‚è¼¯)
                        c.tags = c.tags.filter(t => t !== currentEditUser);
                    }
                });

                saveData();
                initSettingsUI();
                alert("åŒ¯å…¥æˆåŠŸï¼");
                input.value = ""; // æ¸…ç©ºè¼¸å…¥æ¡†

            } catch (e) {
                alert("ç„¡æ•ˆçš„ä»£ç¢¼ï¼Œè«‹ç¢ºèªè¤‡è£½æ˜¯å¦å®Œæ•´ã€‚");
                console.error(e);
            }
        }

        function addNewUser() {
            const name = document.getElementById('new-user-name').value.trim();
            if (name && !users.includes(name)) {
                users.push(name);
                fullData.forEach(c => c.tags.push(name));
                saveData();
                currentEditUser = name;
                initSettingsUI();
                initDrawUI();
                document.getElementById('new-user-name').value = "";
            }
        }

        function saveData() {
            localStorage.setItem('gacha_global_users', JSON.stringify(users));
            const map = {};
            fullData.forEach(c => map[c.name] = c.tags.filter(t => users.includes(t)));
            localStorage.setItem('gacha_owned_' + currentGame, JSON.stringify(map));
        }

        function resetAllData() {
            if (confirm("ç¢ºå®šé‡ç½®ï¼Ÿé€™å°‡æ¸…é™¤æœ¬éŠæˆ²çš„æ‰€æœ‰æ“æœ‰ç‹€æ…‹ã€‚")) {
                localStorage.removeItem('gacha_owned_' + currentGame);
                location.reload();
            }
        }

        function switchPage(p) {
            document.querySelectorAll('.page-section').forEach(e => e.classList.add('hidden'));
            document.getElementById(p + '-page').classList.remove('hidden');
            const navs = document.querySelectorAll('.btn-nav');
            navs.forEach(b => b.classList.remove('active'));
            if (p === 'draw') { navs[0].classList.add('active'); initDrawUI(); }
            else { navs[1].classList.add('active'); initSettingsUI(); }
        }
    </script>
</body>
</html>
